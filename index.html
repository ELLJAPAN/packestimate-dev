<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PackEstimate AI Pro (Dev)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Inter', sans-serif; }
        .mono { font-family: 'JetBrains Mono', monospace; }
        @keyframes fade-in { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .animate-fade-in { animation: fade-in 0.3s ease-out; }
        .animate-pulse { animation: pulse 2s infinite; }
        .glass { background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); }
        .dev-badge { background: linear-gradient(135deg, #f59e0b, #d97706); }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    </style>
</head>
<body class="bg-slate-100 min-h-screen">
    <div id="root"></div>
    <script type="text/babel">
        // ===== Ë®≠ÂÆö =====
        const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbwCTLnz4UK7la_Wpc900rW56PvFrWX3Z5XvouehUn9pmxqo0ksut8xviRKffttHoHE2ew/exec';

        // ===== APIÈÄö‰ø°ÔºàCORSÂØæÁ≠ñÊ∏à„ÅøÔºâ =====
        const server = {
            call: async (action, params = {}) => {
                try {
                    const res = await fetch(GAS_API_URL, {
                        method: 'POST',
                        body: JSON.stringify({ action, ...params }),
                        redirect: 'follow'
                    });
                    return res.json();
                } catch (e) {
                    console.error('API Error:', e);
                    return { success: false, message: e.toString() };
                }
            }
        };

        // ===== „Ç¢„Ç§„Ç≥„É≥„Ç≥„É≥„Éù„Éº„Éç„É≥„Éà =====
        const Icon = ({ name, size = 20, className = '' }) => {
            const ref = React.useRef(null);
            React.useEffect(() => {
                if (ref.current && lucide[name]) {
                    ref.current.innerHTML = '';
                    const svg = lucide.createElement(lucide[name]);
                    svg.setAttribute('width', size);
                    svg.setAttribute('height', size);
                    if (className) svg.setAttribute('class', className);
                    ref.current.appendChild(svg);
                }
            }, [name, size, className]);
            return <span ref={ref} className="inline-flex items-center justify-center" />;
        };

        // ===== „Ç®„É©„Éº„Éê„Ç¶„É≥„ÉÄ„É™ =====
        class ErrorBoundary extends React.Component {
            constructor(props) { super(props); this.state = { hasError: false, error: null }; }
            static getDerivedStateFromError(error) { return { hasError: true, error }; }
            render() {
                if (this.state.hasError) {
                    return (
                        <div className="min-h-screen bg-slate-100 flex items-center justify-center p-4">
                            <div className="bg-white rounded-2xl shadow-xl p-8 max-w-md w-full text-center">
                                <div className="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <Icon name="AlertTriangle" size={32} className="text-red-500" />
                                </div>
                                <h2 className="text-xl font-bold text-slate-800 mb-2">„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü</h2>
                                <p className="text-slate-500 text-sm mb-4">{this.state.error?.message}</p>
                                <button onClick={() => window.location.reload()} className="px-6 py-2 bg-slate-800 text-white rounded-lg hover:bg-slate-700">
                                    ÂÜçË™≠„ÅøËæº„Åø
                                </button>
                            </div>
                        </div>
                    );
                }
                return this.props.children;
            }
        }

        // ===== „É°„Ç§„É≥„Ç¢„Éó„É™ =====
        const App = () => {
            // State
            const [currentUser, setCurrentUser] = React.useState(null);
            const [isLoading, setIsLoading] = React.useState(false);
            const [error, setError] = React.useState('');
            const [logs, setLogs] = React.useState([]);
            const [result, setResult] = React.useState(null);
            
            // ÂÖ•Âäõ„Éï„Ç©„Éº„É†
            const [inputMode, setInputMode] = React.useState('asin');
            const [asinInput, setAsinInput] = React.useState('');
            const [janInput, setJanInput] = React.useState('');
            const [imageFile, setImageFile] = React.useState(null);
            const [imagePreview, setImagePreview] = React.useState(null);
            
            // Ë®≠ÂÆö
            const [showSettings, setShowSettings] = React.useState(false);
            const [showUserManager, setShowUserManager] = React.useState(false);
            const [config, setConfig] = React.useState(() => {
                const saved = localStorage.getItem('packestimate_config');
                return saved ? JSON.parse(saved) : { keepaApiKey: '', serpApiKey: '', geminiApiKey: '' };
            });
            
            // Ê¢±ÂåÖË≥áÊùê
            const [customBoxes, setCustomBoxes] = React.useState(() => {
                const saved = localStorage.getItem('packestimate_boxes');
                return saved ? JSON.parse(saved) : [
                    { id: 1, name: '60„Çµ„Ç§„Ç∫', w: 27, d: 20, h: 13 },
                    { id: 2, name: '80„Çµ„Ç§„Ç∫', w: 37, d: 27, h: 16 },
                    { id: 3, name: '100„Çµ„Ç§„Ç∫', w: 44, d: 34, h: 22 }
                ];
            });
            const [showBoxConfig, setShowBoxConfig] = React.useState(false);
            const [newBox, setNewBox] = React.useState({ name: '', w: '', d: '', h: '' });

            // „É≠„Ç∞„Ç§„É≥Áä∂ÊÖã„ÉÅ„Çß„ÉÉ„ÇØ
            React.useEffect(() => {
                const savedUser = localStorage.getItem('packestimate_user');
                if (savedUser) {
                    setCurrentUser(JSON.parse(savedUser));
                }
            }, []);

            // Ë®≠ÂÆö‰øùÂ≠ò
            React.useEffect(() => {
                localStorage.setItem('packestimate_config', JSON.stringify(config));
            }, [config]);

            // Ê¢±ÂåÖË≥áÊùê‰øùÂ≠ò
            React.useEffect(() => {
                localStorage.setItem('packestimate_boxes', JSON.stringify(customBoxes));
            }, [customBoxes]);

            // „É≠„Ç∞ËøΩÂä†
            const addLog = (message, type = 'info') => {
                const time = new Date().toLocaleTimeString('ja-JP');
                const icons = { info: 'üì¶', success: '‚úÖ', error: '‚ùå', ai: 'üîÆ', keepa: 'üü†' };
                setLogs(prev => [...prev, { time, message, type, icon: icons[type] || 'üì¶' }]);
            };

            // „É≠„Ç∞„Ç§„É≥Âá¶ÁêÜ
            const handleLogin = async (username, password) => {
                setIsLoading(true);
                setError('');
                try {
                    const res = await server.call('login', { username, password });
                    if (res.success) {
                        const user = { username, role: res.role };
                        setCurrentUser(user);
                        localStorage.setItem('packestimate_user', JSON.stringify(user));
                    } else {
                        setError(res.message || '„É≠„Ç∞„Ç§„É≥„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                    }
                } catch (e) {
                    setError('ÈÄö‰ø°„Ç®„É©„Éº: ' + e.message);
                }
                setIsLoading(false);
            };

            // „É≠„Ç∞„Ç¢„Ç¶„Éà
            const handleLogout = () => {
                setCurrentUser(null);
                localStorage.removeItem('packestimate_user');
                setResult(null);
                setLogs([]);
            };

            // ÁîªÂÉèÈÅ∏Êäû
            const handleImageSelect = (e) => {
                const file = e.target.files[0];
                if (file) {
                    setImageFile(file);
                    const reader = new FileReader();
                    reader.onload = (ev) => setImagePreview(ev.target.result);
                    reader.readAsDataURL(file);
                }
            };

            // ÁîªÂÉè„ÇØ„É™„Ç¢
            const clearImage = () => {
                setImageFile(null);
                setImagePreview(null);
            };

            // Ëß£ÊûêÂÆüË°å
            const handleAnalyze = async () => {
                setIsLoading(true);
                setError('');
                setResult(null);
                setLogs([]);
                
                addLog('Ëß£ÊûêÈñãÂßãÔºàDevÁâàÔºâ...', 'info');

                try {
                    let asin = asinInput.trim();
                    let jan = janInput.trim();
                    let keepaData = null;
                    let imageBase64 = null;

                    // ÁîªÂÉè„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØBase64„Å´Â§âÊèõ
                    if (imageFile) {
                        imageBase64 = imagePreview.split(',')[1];
                    }

                    // ÁîªÂÉè„Åã„ÇâASINÊ§úÁ¥¢
                    if (imageBase64 && !asin && !jan) {
                        addLog('Google LensÊ§úÁ¥¢‰∏≠...', 'info');
                        const lensRes = await server.call('googleLensSearch', { 
                            imageBase64,
                            serpApiKey: config.serpApiKey 
                        });
                        if (lensRes.success && lensRes.asin) {
                            asin = lensRes.asin;
                            addLog(`ASINÊ§úÂá∫: ${asin}`, 'success');
                        } else if (lensRes.jan) {
                            jan = lensRes.jan;
                            addLog(`JANÊ§úÂá∫: ${jan}`, 'success');
                        }
                    }

                    // Keepa„Éá„Éº„ÇøÂèñÂæó
                    if (asin || jan) {
                        addLog('KeepaÊ§úÁ¥¢‰∏≠...', 'keepa');
                        const keepaRes = await server.call('fetchKeepaData', {
                            asin: asin || null,
                            jan: jan || null,
                            keepaApiKey: config.keepaApiKey
                        });
                        if (keepaRes.success) {
                            keepaData = keepaRes;
                            asin = keepaRes.asin || asin;
                            addLog('Keepa„Éá„Éº„ÇøÂèñÂæó', 'success');
                        } else {
                            addLog('Keepa„Éá„Éº„Çø„Å™„Åó: ' + (keepaRes.message || ''), 'error');
                        }
                    }

                    // GeminiËß£Êûê
                    addLog('GeminiËß£Êûê‰∏≠...', 'ai');
                    const geminiRes = await server.call('callGemini_Server', {
                        keepaData,
                        imageBase64,
                        geminiApiKey: config.geminiApiKey
                    });

                    if (geminiRes.success) {
                        // ÁîªÂÉèURLÂá¶ÁêÜ
                        let productImage = null;
                        if (imagePreview) {
                            productImage = imagePreview;
                        } else if (keepaData?.images && keepaData.images.length > 0) {
                            const imgCode = keepaData.images[0];
                            if (imgCode.startsWith('http')) {
                                productImage = imgCode;
                            } else {
                                productImage = `https://images-na.ssl-images-amazon.com/images/I/${imgCode}`;
                            }
                        }

                        // „Çµ„Ç§„Ç∫Ë®àÁÆó
                        const w = keepaData?.packageWidth ? keepaData.packageWidth / 10 : geminiRes.width || 0;
                        const d = keepaData?.packageLength ? keepaData.packageLength / 10 : geminiRes.depth || 0;
                        const h = keepaData?.packageHeight ? keepaData.packageHeight / 10 : geminiRes.height || 0;
                        const weight = keepaData?.packageWeight ? keepaData.packageWeight : geminiRes.weight || 0;
                        const totalSize = w + d + h;

                        setResult({
                            titleJa: geminiRes.titleJa || keepaData?.title || '',
                            titleEn: geminiRes.titleEn || '',
                            description: geminiRes.description || '',
                            width: w,
                            depth: d,
                            height: h,
                            weight: weight,
                            totalSize: totalSize,
                            battery: geminiRes.battery || '„Å™„Åó',
                            asin: asin,
                            image: productImage,
                            specs: geminiRes.specs || {}
                        });
                        addLog('Ëß£ÊûêÂÆå‰∫ÜÔºÅ', 'success');
                    } else {
                        setError('GeminiËß£ÊûêÂ§±Êïó: ' + (geminiRes.message || ''));
                        addLog('GeminiËß£ÊûêÂ§±Êïó', 'error');
                    }

                } catch (e) {
                    setError('„Ç®„É©„Éº: ' + e.message);
                    addLog('„Ç®„É©„Éº: ' + e.message, 'error');
                }

                setIsLoading(false);
            };

            // Ê¢±ÂåÖË≥áÊùêËøΩÂä†
            const handleAddBox = () => {
                if (newBox.name && newBox.w && newBox.d && newBox.h) {
                    setCustomBoxes(prev => [...prev, { 
                        id: Date.now(), 
                        name: newBox.name, 
                        w: Number(newBox.w), 
                        d: Number(newBox.d), 
                        h: Number(newBox.h) 
                    }]);
                    setNewBox({ name: '', w: '', d: '', h: '' });
                }
            };

            // Ê¢±ÂåÖË≥áÊùêÂâäÈô§
            const handleDeleteBox = (id) => {
                setCustomBoxes(prev => prev.filter(b => b.id !== id));
            };

            // „É≠„Ç∞„Ç§„É≥ÁîªÈù¢
            if (!currentUser) {
                return <LoginScreen onLogin={handleLogin} isLoading={isLoading} error={error} />;
            }

            // „É°„Ç§„É≥ÁîªÈù¢
            return (
                <div className="min-h-screen bg-slate-100">
                    {/* „Éò„ÉÉ„ÉÄ„Éº */}
                    <header className="bg-slate-900 text-white py-3 px-4 shadow-lg sticky top-0 z-50">
                        <div className="max-w-4xl mx-auto flex items-center justify-between">
                            <div className="flex items-center gap-3">
                                <h1 className="text-lg font-bold">PackEstimate AI Pro</h1>
                                <span className="dev-badge text-xs px-2 py-0.5 rounded-full font-bold text-white">DEV</span>
                            </div>
                            <div className="flex items-center gap-2">
                                {currentUser.role === 'admin' && (
                                    <>
                                        <button onClick={() => setShowUserManager(true)} className="p-2 hover:bg-slate-800 rounded-lg" title="„É¶„Éº„Ç∂„ÉºÁÆ°ÁêÜ">
                                            <Icon name="Users" size={18} />
                                        </button>
                                        <button onClick={() => setShowSettings(true)} className="p-2 hover:bg-slate-800 rounded-lg" title="Ë®≠ÂÆö">
                                            <Icon name="Settings" size={18} />
                                        </button>
                                    </>
                                )}
                                <span className="text-sm text-slate-400">{currentUser.username}</span>
                                <button onClick={handleLogout} className="p-2 hover:bg-slate-800 rounded-lg" title="„É≠„Ç∞„Ç¢„Ç¶„Éà">
                                    <Icon name="LogOut" size={18} />
                                </button>
                            </div>
                        </div>
                    </header>

                    {/* „É°„Ç§„É≥„Ç≥„É≥„ÉÜ„É≥„ÉÑ */}
                    <main className="max-w-4xl mx-auto p-4 pb-20">
                        {/* ÂÖ•Âäõ„Çª„ÇØ„Ç∑„Éß„É≥ */}
                        <div className="bg-white rounded-2xl shadow-sm p-6 mb-4">
                            {/* ÂÖ•Âäõ„É¢„Éº„ÉâÂàáÊõø */}
                            <div className="flex gap-2 mb-4">
                                {['asin', 'jan', 'image'].map(mode => (
                                    <button
                                        key={mode}
                                        onClick={() => setInputMode(mode)}
                                        className={`flex-1 py-2 px-4 rounded-lg text-sm font-medium transition-all ${
                                            inputMode === mode 
                                                ? 'bg-slate-800 text-white' 
                                                : 'bg-slate-100 text-slate-600 hover:bg-slate-200'
                                        }`}
                                    >
                                        {mode === 'asin' ? 'ASIN' : mode === 'jan' ? 'JAN' : 'ÁîªÂÉè'}
                                    </button>
                                ))}
                            </div>

                            {/* ASINÂÖ•Âäõ */}
                            {inputMode === 'asin' && (
                                <input
                                    type="text"
                                    value={asinInput}
                                    onChange={(e) => setAsinInput(e.target.value)}
                                    placeholder="ASIN„ÇíÂÖ•Âäõ (‰æã: B08N5WRWNW)"
                                    className="w-full p-3 border border-slate-200 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-slate-300"
                                />
                            )}

                            {/* JANÂÖ•Âäõ */}
                            {inputMode === 'jan' && (
                                <input
                                    type="text"
                                    value={janInput}
                                    onChange={(e) => setJanInput(e.target.value)}
                                    placeholder="JAN„Ç≥„Éº„Éâ„ÇíÂÖ•Âäõ (‰æã: 4901301384157)"
                                    className="w-full p-3 border border-slate-200 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-slate-300"
                                />
                            )}

                            {/* ÁîªÂÉè„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ */}
                            {inputMode === 'image' && (
                                <div className="space-y-3">
                                    <label className="block w-full p-6 border-2 border-dashed border-slate-300 rounded-xl text-center cursor-pointer hover:border-slate-400 transition-colors">
                                        <input type="file" accept="image/*" onChange={handleImageSelect} className="hidden" />
                                        <Icon name="Upload" size={32} className="mx-auto mb-2 text-slate-400" />
                                        <p className="text-sm text-slate-500">„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶ÁîªÂÉè„Çí„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ</p>
                                    </label>
                                    {imagePreview && (
                                        <div className="relative inline-block">
                                            <img src={imagePreview} alt="Preview" className="max-h-32 rounded-lg" />
                                            <button 
                                                onClick={clearImage}
                                                className="absolute -top-2 -right-2 w-6 h-6 bg-red-500 text-white rounded-full flex items-center justify-center"
                                            >
                                                <Icon name="X" size={14} />
                                            </button>
                                        </div>
                                    )}
                                </div>
                            )}

                            {/* Ëß£Êûê„Éú„Çø„É≥ */}
                            <button
                                onClick={handleAnalyze}
                                disabled={isLoading}
                                className="w-full mt-4 py-3 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-all"
                            >
                                {isLoading ? 'Ëß£Êûê‰∏≠...' : 'Ëß£ÊûêÈñãÂßã'}
                            </button>
                        </div>

                        {/* „É≠„Ç∞Ë°®Á§∫ */}
                        {logs.length > 0 && (
                            <div className="bg-slate-800 rounded-2xl p-4 mb-4 text-sm font-mono">
                                {logs.map((log, i) => (
                                    <div key={i} className={`${
                                        log.type === 'error' ? 'text-red-400' : 
                                        log.type === 'success' ? 'text-green-400' : 
                                        log.type === 'ai' ? 'text-purple-400' :
                                        log.type === 'keepa' ? 'text-orange-400' :
                                        'text-slate-300'
                                    }`}>
                                        <span className="text-slate-500">[{log.time}]</span> {log.icon} {log.message}
                                    </div>
                                ))}
                            </div>
                        )}

                        {/* „Ç®„É©„ÉºË°®Á§∫ */}
                        {error && (
                            <div className="bg-red-50 border border-red-200 text-red-700 rounded-xl p-4 mb-4">
                                {error}
                            </div>
                        )}

                        {/* ÁµêÊûúË°®Á§∫ */}
                        {result && (
                            <div className="bg-white rounded-2xl shadow-sm p-6 space-y-4 animate-fade-in">
                                <h2 className="text-lg font-bold text-slate-800 flex items-center gap-2">
                                    <Icon name="Package" size={20} />
                                    Ëß£ÊûêÁµêÊûú
                                </h2>

                                {/* ÂïÜÂìÅÁîªÂÉè */}
                                {result.image && (
                                    <div className="flex justify-center">
                                        <img 
                                            src={result.image} 
                                            alt="ÂïÜÂìÅÁîªÂÉè" 
                                            className="max-h-48 rounded-xl shadow-sm"
                                            onError={(e) => { e.target.style.display = 'none'; }}
                                        />
                                    </div>
                                )}

                                {/* Êó•Êú¨Ë™û„Çø„Ç§„Éà„É´ */}
                                <div className="bg-slate-50 rounded-xl p-4">
                                    <p className="text-xs text-slate-500 mb-1">Êó•Êú¨Ë™û„Çø„Ç§„Éà„É´</p>
                                    <p className="text-slate-800 font-medium">{result.titleJa}</p>
                                </div>

                                {/* Ëã±Ë™û„Çø„Ç§„Éà„É´ */}
                                <div className="bg-blue-50 rounded-xl p-4">
                                    <p className="text-xs text-blue-600 mb-1">Ëã±Ë™û„Çø„Ç§„Éà„É´ ({result.titleEn?.length || 0}/80)</p>
                                    <p className="text-slate-800 font-medium">{result.titleEn}</p>
                                </div>

                                {/* Ë™¨ÊòéÊñá */}
                                <div className="bg-slate-50 rounded-xl p-4">
                                    <p className="text-xs text-slate-500 mb-1">Ë™¨ÊòéÊñá (EN)</p>
                                    <p className="text-slate-700 text-sm">{result.description}</p>
                                </div>

                                {/* „Çµ„Ç§„Ç∫„ÉªÈáçÈáè */}
                                <div className="grid grid-cols-3 gap-3">
                                    <div className="bg-slate-50 rounded-xl p-4 text-center">
                                        <p className="text-xs text-slate-500">„Çµ„Ç§„Ç∫</p>
                                        <p className="text-lg font-bold text-slate-800 mono">
                                            {result.width}x{result.depth}x{result.height} cm
                                        </p>
                                        {result.totalSize > 0 && (
                                            <p className="text-xs text-slate-400">3Ëæ∫ÂêàË®à: {result.totalSize.toFixed(1)}cm</p>
                                        )}
                                    </div>
                                    <div className="bg-slate-50 rounded-xl p-4 text-center">
                                        <p className="text-xs text-slate-500">ÈáçÈáè</p>
                                        <p className="text-lg font-bold text-slate-800 mono">{result.weight} g</p>
                                    </div>
                                    <div className="bg-slate-50 rounded-xl p-4 text-center">
                                        <p className="text-xs text-slate-500">„Éê„ÉÉ„ÉÜ„É™„Éº</p>
                                        <p className="text-lg font-bold text-slate-800">{result.battery}</p>
                                    </div>
                                </div>

                                {/* eBayÂá∫ÂìÅ„Éú„Çø„É≥ */}
                                <button
                                    onClick={() => alert('eBayÂá∫ÂìÅÊ©üËÉΩ„ÅØÈñãÁô∫‰∏≠„Åß„Åô')}
                                    className="w-full py-4 bg-gradient-to-r from-orange-500 to-red-500 text-white rounded-xl font-bold hover:from-orange-600 hover:to-red-600 transition-all shadow-lg"
                                >
                                    eBay„Å´Âá∫ÂìÅ„Åô„Çã
                                </button>
                            </div>
                        )}

                        {/* Ê¢±ÂåÖË≥áÊùê */}
                        <div className="bg-white rounded-2xl shadow-sm p-4 mt-4">
                            <div className="flex items-center justify-between mb-3">
                                <h3 className="font-bold text-slate-800 flex items-center gap-2">
                                    <Icon name="Box" size={16} />
                                    Ê¢±ÂåÖË≥áÊùê
                                </h3>
                                <button 
                                    onClick={() => setShowBoxConfig(!showBoxConfig)}
                                    className="text-xs text-blue-600 hover:underline"
                                >
                                    {showBoxConfig ? 'Èñâ„Åò„Çã' : 'Á∑®ÈõÜ'}
                                </button>
                            </div>

                            {showBoxConfig && (
                                <div className="space-y-3 animate-fade-in mb-4">
                                    <div className="space-y-2 p-3 bg-slate-50 rounded-xl">
                                        <input
                                            type="text"
                                            placeholder="Ë≥áÊùêÂêç"
                                            value={newBox.name}
                                            onChange={(e) => setNewBox({ ...newBox, name: e.target.value })}
                                            className="w-full p-2 text-xs border rounded-lg"
                                        />
                                        <div className="flex gap-2">
                                            <input type="number" placeholder="W" value={newBox.w} onChange={(e) => setNewBox({ ...newBox, w: e.target.value })} className="w-1/3 p-2 text-xs border rounded-lg" />
                                            <input type="number" placeholder="D" value={newBox.d} onChange={(e) => setNewBox({ ...newBox, d: e.target.value })} className="w-1/3 p-2 text-xs border rounded-lg" />
                                            <input type="number" placeholder="H" value={newBox.h} onChange={(e) => setNewBox({ ...newBox, h: e.target.value })} className="w-1/3 p-2 text-xs border rounded-lg" />
                                        </div>
                                        <button onClick={handleAddBox} className="w-full py-1.5 bg-slate-800 text-white text-xs rounded-lg font-bold">
                                            ËøΩÂä†
                                        </button>
                                    </div>
                                </div>
                            )}

                            <div className="max-h-48 overflow-y-auto space-y-1 pr-1">
                                {customBoxes.map(box => (
                                    <div key={box.id} className="flex justify-between items-center text-xs p-2.5 bg-white border border-slate-100 rounded-lg shadow-sm">
                                        <span className="font-mono text-slate-700 flex flex-col">
                                            <span className="font-bold text-slate-800">{box.name}</span>
                                            <span className="text-[10px] text-slate-400">{box.w}√ó{box.d}√ó{box.h}</span>
                                        </span>
                                        {showBoxConfig && (
                                            <button onClick={() => handleDeleteBox(box.id)} className="text-slate-300 hover:text-red-500">
                                                <Icon name="X" size={14} />
                                            </button>
                                        )}
                                    </div>
                                ))}
                            </div>
                        </div>
                    </main>

                    {/* Ë®≠ÂÆö„É¢„Éº„ÉÄ„É´ */}
                    {showSettings && (
                        <SettingsModal 
                            config={config} 
                            setConfig={setConfig} 
                            onClose={() => setShowSettings(false)} 
                        />
                    )}

                    {/* „É¶„Éº„Ç∂„ÉºÁÆ°ÁêÜ„É¢„Éº„ÉÄ„É´ */}
                    {showUserManager && (
                        <UserManagerModal 
                            currentUser={currentUser}
                            onClose={() => setShowUserManager(false)} 
                        />
                    )}
                </div>
            );
        };

        // ===== „É≠„Ç∞„Ç§„É≥ÁîªÈù¢ =====
        const LoginScreen = ({ onLogin, isLoading, error }) => {
            const [username, setUsername] = React.useState('');
            const [password, setPassword] = React.useState('');

            const handleSubmit = (e) => {
                e.preventDefault();
                onLogin(username, password);
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-slate-900 to-slate-800 flex items-center justify-center p-4">
                    <div className="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-sm">
                        <div className="text-center mb-6">
                            <div className="flex items-center justify-center gap-2 mb-2">
                                <h1 className="text-2xl font-bold text-slate-800">PackEstimate AI Pro</h1>
                            </div>
                            <span className="dev-badge text-xs px-3 py-1 rounded-full font-bold text-white">DEVELOPMENT</span>
                        </div>

                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-slate-600 mb-1">„É¶„Éº„Ç∂„ÉºÂêç</label>
                                <input
                                    type="text"
                                    value={username}
                                    onChange={(e) => setUsername(e.target.value)}
                                    className="w-full p-3 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-slate-300"
                                    placeholder="admin"
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-slate-600 mb-1">„Éë„Çπ„ÉØ„Éº„Éâ</label>
                                <input
                                    type="password"
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                    className="w-full p-3 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-slate-300"
                                    placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                                />
                            </div>

                            {error && (
                                <div className="text-red-500 text-sm text-center bg-red-50 p-2 rounded-lg">
                                    {error}
                                </div>
                            )}

                            <button
                                type="submit"
                                disabled={isLoading}
                                className="w-full py-3 bg-slate-800 text-white rounded-xl font-bold hover:bg-slate-700 disabled:opacity-50 transition-all"
                            >
                                {isLoading ? '„É≠„Ç∞„Ç§„É≥‰∏≠...' : '„É≠„Ç∞„Ç§„É≥'}
                            </button>
                        </form>

                        <p className="text-center text-xs text-slate-400 mt-6">
                            eBayËº∏Âá∫„Çª„É©„ÉºÂêë„ÅëÂïÜÂìÅËß£Êûê„ÉÑ„Éº„É´
                        </p>
                    </div>
                </div>
            );
        };

        // ===== Ë®≠ÂÆö„É¢„Éº„ÉÄ„É´ =====
        const SettingsModal = ({ config, setConfig, onClose }) => {
            const [tempConfig, setTempConfig] = React.useState(config);

            const handleSave = async () => {
                setConfig(tempConfig);
                // „Çµ„Éº„Éê„Éº„Å´„ÇÇ‰øùÂ≠ò
                await server.call('saveConfig', { config: tempConfig, adminUser: 'admin' });
                onClose();
            };

            return (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-2xl shadow-xl w-full max-w-md p-6 animate-fade-in">
                        <div className="flex items-center justify-between mb-4">
                            <h2 className="text-lg font-bold text-slate-800">APIË®≠ÂÆö</h2>
                            <button onClick={onClose} className="p-2 hover:bg-slate-100 rounded-lg">
                                <Icon name="X" size={20} />
                            </button>
                        </div>

                        <div className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-slate-600 mb-1">Keepa API Key</label>
                                <input
                                    type="password"
                                    value={tempConfig.keepaApiKey}
                                    onChange={(e) => setTempConfig({ ...tempConfig, keepaApiKey: e.target.value })}
                                    className="w-full p-3 border border-slate-200 rounded-xl text-sm"
                                    placeholder="Keepa API„Ç≠„Éº"
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-slate-600 mb-1">SerpAPI Key</label>
                                <input
                                    type="password"
                                    value={tempConfig.serpApiKey}
                                    onChange={(e) => setTempConfig({ ...tempConfig, serpApiKey: e.target.value })}
                                    className="w-full p-3 border border-slate-200 rounded-xl text-sm"
                                    placeholder="SerpAPI „Ç≠„Éº"
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-slate-600 mb-1">Gemini API Key</label>
                                <input
                                    type="password"
                                    value={tempConfig.geminiApiKey}
                                    onChange={(e) => setTempConfig({ ...tempConfig, geminiApiKey: e.target.value })}
                                    className="w-full p-3 border border-slate-200 rounded-xl text-sm"
                                    placeholder="Gemini API„Ç≠„Éº"
                                />
                            </div>
                        </div>

                        <div className="flex gap-3 mt-6">
                            <button onClick={onClose} className="flex-1 py-2 border border-slate-200 rounded-xl hover:bg-slate-50">
                                „Ç≠„É£„É≥„Çª„É´
                            </button>
                            <button onClick={handleSave} className="flex-1 py-2 bg-slate-800 text-white rounded-xl hover:bg-slate-700">
                                ‰øùÂ≠ò
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // ===== „É¶„Éº„Ç∂„ÉºÁÆ°ÁêÜ„É¢„Éº„ÉÄ„É´ =====
        const UserManagerModal = ({ currentUser, onClose }) => {
            const [users, setUsers] = React.useState([]);
            const [newUser, setNewUser] = React.useState({ username: '', password: '', role: 'user' });
            const [isLoading, setIsLoading] = React.useState(false);

            // „É¶„Éº„Ç∂„Éº‰∏ÄË¶ßÂèñÂæó
            React.useEffect(() => {
                loadUsers();
            }, []);

            const loadUsers = async () => {
                setIsLoading(true);
                const res = await server.call('getUsers', { adminUser: currentUser.username });
                if (res.success) {
                    setUsers(res.users);
                }
                setIsLoading(false);
            };

            const handleAddUser = async () => {
                if (!newUser.username || !newUser.password) return;
                setIsLoading(true);
                const res = await server.call('addUser', {
                    username: newUser.username,
                    password: newUser.password,
                    role: newUser.role,
                    adminUser: currentUser.username
                });
                if (res.success) {
                    setNewUser({ username: '', password: '', role: 'user' });
                    loadUsers();
                }
                setIsLoading(false);
            };

            const handleToggleUser = async (username, enabled) => {
                setIsLoading(true);
                await server.call('toggleUser', {
                    targetUser: username,
                    enabled: !enabled,
                    adminUser: currentUser.username
                });
                loadUsers();
            };

            return (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-2xl shadow-xl w-full max-w-md p-6 animate-fade-in max-h-[80vh] overflow-y-auto">
                        <div className="flex items-center justify-between mb-4">
                            <h2 className="text-lg font-bold text-slate-800">„É¶„Éº„Ç∂„ÉºÁÆ°ÁêÜ</h2>
                            <button onClick={onClose} className="p-2 hover:bg-slate-100 rounded-lg">
                                <Icon name="X" size={20} />
                            </button>
                        </div>

                        {/* Êñ∞Ë¶è„É¶„Éº„Ç∂„ÉºËøΩÂä† */}
                        <div className="bg-slate-50 rounded-xl p-4 mb-4">
                            <h3 className="text-sm font-bold text-slate-700 mb-3">Êñ∞Ë¶è„É¶„Éº„Ç∂„ÉºËøΩÂä†</h3>
                            <div className="space-y-2">
                                <input
                                    type="text"
                                    placeholder="„É¶„Éº„Ç∂„ÉºÂêç"
                                    value={newUser.username}
                                    onChange={(e) => setNewUser({ ...newUser, username: e.target.value })}
                                    className="w-full p-2 text-sm border rounded-lg"
                                />
                                <input
                                    type="password"
                                    placeholder="„Éë„Çπ„ÉØ„Éº„Éâ"
                                    value={newUser.password}
                                    onChange={(e) => setNewUser({ ...newUser, password: e.target.value })}
                                    className="w-full p-2 text-sm border rounded-lg"
                                />
                                <select
                                    value={newUser.role}
                                    onChange={(e) => setNewUser({ ...newUser, role: e.target.value })}
                                    className="w-full p-2 text-sm border rounded-lg"
                                >
                                    <option value="user">‰∏ÄËà¨„É¶„Éº„Ç∂„Éº</option>
                                    <option value="admin">ÁÆ°ÁêÜËÄÖ</option>
                                </select>
                                <button
                                    onClick={handleAddUser}
                                    disabled={isLoading}
                                    className="w-full py-2 bg-blue-600 text-white text-sm rounded-lg hover:bg-blue-700 disabled:opacity-50"
                                >
                                    ËøΩÂä†
                                </button>
                            </div>
                        </div>

                        {/* „É¶„Éº„Ç∂„Éº‰∏ÄË¶ß */}
                        <div className="space-y-2">
                            {users.map(user => (
                                <div key={user.username} className="flex items-center justify-between p-3 bg-white border rounded-xl">
                                    <div>
                                        <p className="font-medium text-slate-800">{user.username}</p>
                                        <p className="text-xs text-slate-500">{user.role === 'admin' ? 'ÁÆ°ÁêÜËÄÖ' : '‰∏ÄËà¨'}</p>
                                    </div>
                                    {user.username !== 'admin' && (
                                        <button
                                            onClick={() => handleToggleUser(user.username, user.enabled)}
                                            className={`px-3 py-1 text-xs rounded-lg ${
                                                user.enabled 
                                                    ? 'bg-green-100 text-green-700' 
                                                    : 'bg-red-100 text-red-700'
                                            }`}
                                        >
                                            {user.enabled ? 'ÊúâÂäπ' : 'ÁÑ°Âäπ'}
                                        </button>
                                    )}
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        // ===== „É¨„É≥„ÉÄ„É™„É≥„Ç∞ =====
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(
            <ErrorBoundary>
                <App />
            </ErrorBoundary>
        );
    </script>
</body>
</html>
